# Pass 7: Deep Dive Analysis

> 這是整個審計流程中**最重要**的 Pass。
> 自動化工具 (V12, Slither, 4naly3er) 能找到的漏洞模式是有限的。
> **業務邏輯漏洞**往往需要人類級別的理解才能發現。

## 為什麼需要 Deep Dive?

| 自動化工具擅長 | 自動化工具不擅長 |
|---------------|-----------------|
| 重入、未檢查返回值 | 業務邏輯缺陷 |
| 存取控制缺失 | 經濟攻擊向量 |
| 已知漏洞模式 | 跨合約狀態不一致 |
| Inline assembly 問題 | 狀態機轉換漏洞 |
| 溢出/下溢 | 協議特定不變量違反 |

**真正有價值的 High/Critical 發現往往來自 Deep Dive。**

---

## 執行方法

### 方法 1: 並行 Sub-Agents (推薦)

針對不同高風險區域啟動專門的 sub-agents：

```
┌─────────────────────────────────────────────────────────────┐
│                    Pass 7: Deep Dive                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Sub-Agent 1 │  │ Sub-Agent 2 │  │ Sub-Agent 3 │         │
│  │ 業務邏輯    │  │ 跨合約交互  │  │ 協議特定    │         │
│  │ + 經濟攻擊  │  │ + 狀態一致  │  │ 深挖        │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│         │               │               │                   │
│         ▼               ▼               ▼                   │
│  ┌─────────────────────────────────────────────────┐       │
│  │            合併 + 去重 + 驗證                    │       │
│  └─────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

### Sub-Agent 1: 業務邏輯 + 經濟攻擊

**專注領域：**
- 數學公式驗證（手動展開、具體數字測試）
- 狀態機分析（狀態轉換是否可跳過？）
- 經濟攻擊向量（Flash Loan、三明治、MEV）
- 通脹/獎勵分配操縱
- 累積值被意外重置

**分析方法：**
```
1. 代數驗證 (最先做！)
   - 提取完整數學公式
   - 用符號展開並簡化
   - 檢查是否有變數被意外消除
   
2. 數字驗證
   - 用 3 組具體數字測試 (正常值、邊界值、極端值)
   - 邊界值: 0, 1, MAX_UINT
   
3. 攻擊者視角
   - 如果能控制輸入 X，能否獲利？
   - Flash Loan 能放大嗎？
   - 跨多個 epoch/block 的攻擊？
```

### Sub-Agent 2: 跨合約交互

**專注領域：**
- 合約間狀態一致性
- 外部調用後的狀態
- 重入風險（不僅是 ETH，還有 ERC-777、callback）
- 權限邊界

**分析方法：**
```
1. 畫出合約交互圖
   Contract A ──call──> Contract B ──call──> Contract C
   
2. 在每個交互點問：
   - 如果這個 call 失敗但不 revert？
   - 如果這個 call 重入？
   - 狀態在這兩個合約間是否一致？
   
3. 特別注意：
   - approve + external call 組合
   - 先更新狀態還是先外部調用？
   - 是否有「狀態更新但外部調用失敗」的情況？
```

### Sub-Agent 3: 協議特定深挖

根據協議類型選擇分析重點：

| 協議類型 | 深挖重點 |
|----------|---------|
| **Tokenomics** | Epoch checkpoint 時機、通脹計算、effectiveBond 累積 |
| **Staking** | stake/unstake/claim 狀態機、獎勵公平性、eviction 邏輯 |
| **Bridge** | 訊息驗證完整性、delivery 失敗恢復、重放保護 |
| **Governance** | 投票權計算、timelock 繞過、提案執行 |
| **Lending** | 清算邏輯、Oracle 依賴、利率計算 |
| **DEX/AMM** | 滑點保護、LP 份額計算、fee 分配 |

---

## 輸出要求

### 每個 Sub-Agent 輸出格式

```markdown
# Deep Dive: [領域名稱]

## 分析範圍
- 合約列表
- 重點函數

## 發現

### [DD-01] [標題]
**嚴重性:** High/Medium/Low
**位置:** file.sol:line
**描述:** [問題是什麼]
**數學/邏輯證明:** [具體數字或代數展開]
**攻擊場景:** [步驟]
**影響:** [誰損失多少]
**修復建議:** [代碼]

## 已驗證安全的項目
[列出分析過但確認安全的項目，避免重複工作]

## 與已知問題的對比
[確認不是 V12/其他審計已報告的問題]
```

---

## 關鍵原則

### 1. 質量 > 數量
一個真正的 High/Critical 發現比十個 Low 更有價值。
不要為了填充報告而報告低價值問題。

### 2. 去重很重要
在報告前，必須與以下對比：
- V12 自動審計報告
- 之前的審計報告（如有）
- 已知問題文檔

### 3. 數字證明
業務邏輯漏洞**必須**有具體數字證明。
「可能有問題」不夠，要證明「輸入 X 導致損失 Y」。

### 4. 攻擊者視角
永遠從攻擊者角度思考：
- 這值得攻擊嗎？（成本 vs 收益）
- 攻擊需要什麼前提條件？
- 能用 Flash Loan 放大嗎？

### 5. 跨 epoch/block 思維
很多漏洞不是單筆交易，而是跨多個時間點：
- 先設置狀態 → 等待 → 利用
- checkpoint 時機操縱
- 前後 epoch 的狀態差異

---

## 常見 Deep Dive 發現類型

### 1. 累積值重置
```solidity
// 危險：累積值被重置而非累加
effectiveBond = curMaxBond;  // 應該是 += ?
stakingIncentive = 0;        // 之前累積的呢？
```

### 2. 狀態更新但外部調用失敗
```solidity
service.state = Deployed;
// multisig 創建失敗但狀態已更新
address multisig = IMultisigFactory(factory).create(...);
if (multisig == address(0)) {
    // 狀態已經錯誤更新了！
}
```

### 3. 順序依賴
```solidity
// 第一個 staker 總是獲得取整餘數
for (uint i = 0; i < stakers.length; i++) {
    rewards[i] = total / stakers.length;
}
// 餘數去哪了？
```

### 4. 外部依賴失敗無恢復
```solidity
// Wormhole delivery 失敗後無法重試
wormholeRelayer.sendPayloadToEvm(...);
// 如果 delivery 失敗，治理提案卡住
```

### 5. 時間窗口攻擊
```solidity
// 捐款和 checkpoint 可以在相鄰 block
// 但 TWAP 需要更長時間才有意義
if (lastDonationBlockNumber == block.number) revert;
// block.number + 1 就可以繞過！
```

---

## 執行 Checklist

- [ ] 啟動 3 個專門的 sub-agents
- [ ] 每個 sub-agent 有明確的分析範圍
- [ ] 讀取並排除已知問題（V12、之前審計）
- [ ] 每個發現有數學/邏輯證明
- [ ] 與自動化工具發現去重
- [ ] 輸出結構化的 markdown 報告
- [ ] 按嚴重性排序發現
- [ ] 標記「已驗證安全」的項目

---

*最後更新: 2026-02-01 | 來源: Olas 審計經驗*
