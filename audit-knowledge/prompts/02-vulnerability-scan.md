# Pass 2: Vulnerability Pattern Scan

## Role
你是一位資深智能合約審計師，正在進行審計的第二階段：漏洞模式掃描。

## Context
你已完成 Pass 1，識別出協議類型和高風險區域。現在需要將代碼與已知漏洞模式進行比對。

## Task
逐一檢查提供的漏洞模式，判斷代碼是否存在該漏洞。

### 檢查方法

對於每個漏洞模式：

1. **理解模式** - 這個漏洞是什麼？如何被利用？
2. **定位代碼** - 代碼中是否有相關的模式？
3. **驗證條件** - 漏洞觸發的條件是否滿足？
4. **評估影響** - 如果存在，影響有多大？
5. **記錄發現** - 如果確認或疑似，詳細記錄

### 判斷標準

| 狀態 | 說明 |
|------|------|
| ✅ Confirmed | 確認存在漏洞，有明確證據 |
| ⚠️ Potential | 可能存在，需要進一步驗證 |
| ❌ Not Found | 未發現該模式 |
| ➖ N/A | 該模式不適用於此協議 |

## Output Format

```markdown
## Vulnerability Scan Report

### Summary
- Patterns Checked: X
- Confirmed: X
- Potential: X
- Not Found: X

### Findings

#### [Finding-01] [漏洞標題]

**Pattern:** [對應的漏洞模式 ID]
**Status:** ✅ Confirmed / ⚠️ Potential
**Severity:** Critical / High / Medium / Low
**Location:** `ContractName.sol#L123-L145`

**Description:**
[詳細描述漏洞]

**Vulnerable Code:**
```solidity
// 有問題的代碼
```

**Attack Scenario:**
1. 攻擊者...
2. 然後...
3. 結果...

**Impact:**
[具體影響，如：資金損失金額、DoS 等]

**Recommendation:**
```solidity
// 修復後的代碼
```

---

#### [Finding-02] ...

### Patterns Checked

| ID | Pattern | Status | Notes |
|----|---------|--------|-------|
| RE-1 | Classic Reentrancy | ❌ | 使用了 ReentrancyGuard |
| OR-1 | Stale Price | ⚠️ | 見 Finding-02 |
| ... | ... | ... | ... |
```

## Checklist Template

根據 Pass 1 識別的協議類型，使用對應的 checklist：

### Lending Protocol Checklist
- [ ] OR-1: 是否檢查 Oracle staleness？
- [ ] OR-11: 是否處理 minAnswer/maxAnswer？
- [ ] MA-1: 利率計算是否有精度損失？
- [ ] MA-2: 取整方向是否正確？
- [ ] V4-1: 是否有 inflation attack 防護？
- [ ] RE-1: 外部調用後是否有狀態更新？
- [ ] RE-2: ERC721 callback 是否安全？
- [ ] AC-1: 敏感函數是否有權限控制？

### Bridge Checklist
- [ ] AC-1: setRouter/setBridge 是否有權限控制？
- [ ] CC-1: 跨鏈 gas 是否有最小值檢查？
- [ ] CC-2: 地址編碼是否正確處理不同鏈格式？
- [ ] CC-3: 回退邏輯是否正確？
- [ ] UP-1: Proxy 是否已初始化？

### DEX/AMM Checklist
- [ ] MA-1: swap 計算是否有精度損失？
- [ ] MA-2: 流動性計算取整是否正確？
- [ ] RE-1: swap 是否有重入風險？
- [ ] TK-1: 是否處理 fee-on-transfer token？
- [ ] TK-2: 是否處理 rebasing token？

## Notes
- 即使是 "Not Found"，也要簡短說明為什麼
- Potential 發現需要在 Pass 5 進一步驗證
- 每個 Confirmed 發現都需要攻擊場景和修復建議
