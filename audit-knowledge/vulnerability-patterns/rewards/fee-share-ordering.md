# Fee Share Minting Order

## 類別
Rewards Distribution / State Ordering

## 描述
當協議同時有 fee shares（管理費）和 rewards 分配時，mint fee shares 和計算 rewards 的順序會影響公平性。

## 漏洞模式

### 問題 1：Rewards 先於 Fee Shares

```solidity
function _claimRewards() internal {
    // 1. 計算並分配 rewards（使用當前 totalSupply）
    uint256 totalSupply = totalSupply();  // 不包含即將 mint 的 fee shares
    for (user in users) {
        reward[user] = calculateReward(balanceOf(user), totalSupply);
    }
    
    // 2. 之後才 mint fee shares
    _mintFeeShares();  // 增加 totalSupply
}
```

**結果**：feeRecipient 獲得 shares 但沒有對應時期的 rewards

### 問題 2：Transfer 跳過 Fee Accrual

```solidity
// deposit/withdraw 正確處理
function deposit(...) {
    _accrueFee();  // ✅ 先更新 fee
    _claimRewards();
    // ...
}

// 但 transfer 跳過
function _update(address from, address to, uint256 value) internal override {
    // ❌ 沒有 _accrueFee()
    _claimRewards();  // 用錯誤的 totalSupply 計算
    super._update(from, to, value);
}
```

**結果**：transfer 時的 rewards 計算不準確

## 影響
- Fee recipient 損失應得 rewards
- 其他用戶獲得過多 rewards
- 協議收益低於預期

## 修復方式

### 正確順序
```solidity
function _claimRewards() internal {
    // 1. 先 mint fee shares
    _accrueFee();  // 更新 totalSupply
    
    // 2. 再計算 rewards（使用正確的 totalSupply）
    uint256 totalSupply = totalSupply();  // 包含 fee shares
    // ...
}
```

### 統一入口
```solidity
function _beforeAnyShareChange() internal {
    _accrueFee();
    _updateRewards();
}

function deposit(...) {
    _beforeAnyShareChange();
    // ...
}

function transfer(...) {
    _beforeAnyShareChange();
    super.transfer(...);
}
```

## 通用原則

1. **先更新狀態，再計算分配**
   - 先 mint/burn 任何需要的 shares
   - 再基於最終 totalSupply 計算 rewards

2. **所有 share 變動路徑都要一致**
   - deposit, withdraw, transfer, transferFrom
   - mint, redeem
   - 任何 admin 操作

3. **用 modifier 或 hook 強制執行**
```solidity
modifier updateState() {
    _accrueFee();
    _updateRewards();
    _;
}

function deposit(...) external updateState { ... }
function withdraw(...) external updateState { ... }
```

## 檢測方法
1. 找出所有改變 shares 的函數
2. 檢查每個函數是否在操作前調用 fee/reward 更新
3. 特別注意 `_update()` / `_beforeTokenTransfer()` / `_afterTokenTransfer()` hooks

## 真實案例
- **Silo Finance 2025 (M-02, M-05)** - transfer 跳過 accrueFee，rewards 在 fee shares 前分配

## Checklist
- [ ] 所有 share 變動函數都先更新 fee？
- [ ] fee shares mint 在 rewards 計算之前？
- [ ] transfer/transferFrom 與 deposit/withdraw 行為一致？
- [ ] 有測試覆蓋不同操作順序？
