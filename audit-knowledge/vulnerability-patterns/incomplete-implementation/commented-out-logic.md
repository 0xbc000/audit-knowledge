# 被註釋的關鍵邏輯 (Commented-Out Critical Logic)

## 風險等級
**High** - 核心功能未實現可導致資金損失

## 描述
開發者（或 AI）產生了正確的邏輯但將其註釋掉，用硬編碼或簡化版本替代。這在 AI 生成的程式碼中特別常見。

## 漏洞模式

### 類型 1: 硬編碼替代動態計算

```solidity
// ❌ RAAC - StabilityPool.sol
function getExchangeRate() public view returns (uint256) {
    // 正確邏輯被註釋：
    // uint256 totalDeCRVUSD = deToken.totalSupply();
    // uint256 totalRcrvUSD = rToken.balanceOf(address(this));
    // return (totalRcrvUSD * scalingFactor) / totalDeCRVUSD;
    
    return 1e18;  // ← 永遠返回 1:1，套利漏洞
}
```

**影響**: 
- 匯率永遠 1:1，與實際資產價值脫鉤
- 攻擊者可無限套利

### 類型 2: FIXME 標記未處理

```solidity
// ❌ RAAC - VotingPowerLib.sol
function calculateAndUpdatePower(...) internal returns (int128 bias, int128 slope) {
    // FIXME: Get me to uncomment me when able
    // bias = RAACVoting.calculateBias(amount, unlockTime, block.timestamp);
    // slope = RAACVoting.calculateSlope(amount);

    // 簡化版本：
    uint256 duration = unlockTime - block.timestamp;
    uint256 initialPower = (amount * duration) / MAX_LOCK_DURATION;
    bias = int128(int256(initialPower));
    slope = int128(int256(initialPower / duration));
}
```

**影響**:
- 投票權計算與設計規格不符
- 可能導致治理攻擊

### 類型 3: TODO 未完成

```solidity
// ❌ RAAC - StabilityPool.sol
function distributeFunds() internal {
    // TODO: Logic for distributing to managers based on allocation
    // ← 完全沒有實作
}
```

**影響**:
- 功能不存在
- 資金可能被卡住

## 檢測方法

### 1. 搜尋關鍵字
```bash
# 找被註釋的邏輯
grep -rn "// TODO" contracts/
grep -rn "// FIXME" contracts/
grep -rn "// HACK" contracts/
grep -rn "// XXX" contracts/

# 找被註釋但有 return 的
grep -rn "// return" contracts/
grep -rn "//return" contracts/
```

### 2. 對比文檔與實作
- 檢查 @notice/@dev 描述的功能是否真的存在
- 檢查 @return 說明的返回值是否正確計算

### 3. 找硬編碼返回值
```solidity
// 可疑模式
function getPrice() returns (uint256) { return 1e18; }
function getRate() returns (uint256) { return 100; }
function isValid() returns (bool) { return true; }
```

## 修復方式

1. **取消註釋並測試** - 啟用被註釋的正確邏輯
2. **實作 TODO** - 完成未完成的功能
3. **刪除死代碼** - 如果不需要，移除註釋的程式碼

## 真實案例

| 專案 | 位置 | 影響 |
|------|------|------|
| RAAC 2025 | StabilityPool.getExchangeRate | High - 套利漏洞 |
| RAAC 2025 | VotingPowerLib | Medium - 投票權錯誤 |
| RAAC 2025 | StabilityPool.distributeFunds | Medium - 功能缺失 |

## AI 程式碼特徵

此漏洞在 AI 生成的程式碼中特別常見，因為：
1. AI 會產生「骨架程式碼」等待人類填補
2. AI 可能無法處理複雜的業務邏輯
3. AI 的 FIXME/TODO 常被開發者忽略

**審計 AI 程式碼時務必搜尋所有 TODO/FIXME！**

## 相關模式
- [hardcoded-values.md](../business-logic/hardcoded-values.md)
