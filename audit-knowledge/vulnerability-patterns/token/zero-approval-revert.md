# Zero Approval Revert

## 類別
Token Compatibility / Weird ERC20

## 描述
某些 ERC20 token（如 BNB）在 `approve(spender, 0)` 時會 revert，而非正常設定 allowance 為 0。
這會導致依賴 "reset approval to zero" 邏輯的協議出現問題。

## 漏洞模式

### 問題程式碼
```solidity
// 嘗試移除 market 時重設 approval
function removeMarket(address market) external {
    // ...
    IERC20(asset).approve(market, 0);  // ❌ 某些 token 會 revert
}
```

### OpenZeppelin forceApprove 不足
```solidity
function forceApprove(IERC20 token, address spender, uint256 value) internal {
    bytes memory approvalCall = abi.encodeCall(token.approve, (spender, value));
    if (!_callOptionalReturnBool(token, approvalCall)) {
        // 先設為 0，再設為目標值
        _callOptionalReturn(token, abi.encodeCall(token.approve, (spender, 0)));
        _callOptionalReturn(token, approvalCall);
    }
}
```

當 `value = 0` 時，`forceApprove` 也會失敗，因為：
1. 第一次 approve(0) 失敗
2. 進入 fallback：先 approve(0) - 再次失敗

## 影響
- 無法移除特定 market/spender
- 可能導致 queue 滿，無法新增新 market
- 協議功能受限

## 修復方式

### 方案 1：使用最小值代替 0
```solidity
// 用 1 wei 代替 0
uint256 approveValue = _newCap > 0 ? type(uint256).max : 1;
IERC20(asset).forceApprove(market, approveValue);
```

### 方案 2：檢測並跳過
```solidity
function safeResetApproval(IERC20 token, address spender) internal {
    try token.approve(spender, 0) {} catch {
        // 嘗試設為 1
        try token.approve(spender, 1) {} catch {
            // 記錄但不 revert
        }
    }
}
```

## 受影響 Token
- BNB (BSC)
- 其他非標準 ERC20

## 檢測方法
1. 搜索 `approve(..., 0)` 調用
2. 檢查是否處理 revert 情況
3. 測試已知的 weird token

## 真實案例
- **Silo Finance 2025 (M-03)** - 無法移除使用 BNB 類 token 的 market

## 相關
- [Weird ERC20 Repository](https://github.com/d-xo/weird-erc20)
- `vulnerability-patterns/token/erc1155-compliance.md`
