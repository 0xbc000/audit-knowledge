# ERC-1155 合規性問題 (ERC-1155 Compliance Issues)

## 風險等級
**Medium** - 可能導致代幣丟失或合約不相容

## 描述

ERC-1155 標準要求在轉移代幣到合約地址時，必須調用接收者的 `onERC1155Received` 或 `onERC1155BatchReceived` 函數。如果協議沒有實現這些檢查，可能導致代幣被永久鎖定在不支持 ERC-1155 的合約中。

## 漏洞模式

```solidity
// ❌ Beanstalk - SiloFacet.sol
function safeTransferFrom(
    address from,
    address to,
    uint256 id,
    uint256 amount,
    bytes calldata data
) external {
    // 轉移邏輯...
    _transfer(from, to, id, amount);
    
    // ❌ 缺少接收者檢查
    // 應該調用: _doSafeTransferAcceptanceCheck(operator, from, to, id, amount, data)
}

// ✅ 正確實現 (OpenZeppelin)
function safeTransferFrom(...) public virtual override {
    // ...轉移邏輯...
    
    _doSafeTransferAcceptanceCheck(operator, from, to, id, amount, data);
}

function _doSafeTransferAcceptanceCheck(
    address operator,
    address from,
    address to,
    uint256 id,
    uint256 amount,
    bytes memory data
) private {
    if (to.isContract()) {
        try IERC1155Receiver(to).onERC1155Received(operator, from, id, amount, data) 
            returns (bytes4 response) 
        {
            if (response != IERC1155Receiver.onERC1155Received.selector) {
                revert("ERC1155: ERC1155Receiver rejected tokens");
            }
        } catch Error(string memory reason) {
            revert(reason);
        } catch {
            revert("ERC1155: transfer to non ERC1155Receiver implementer");
        }
    }
}
```

## 影響

1. **代幣丟失** - 轉移到不支持 ERC-1155 的合約會永久鎖定
2. **整合失敗** - 無法與其他 DeFi 協議正確整合
3. **標準不合規** - 無法通過 ERC-1155 合規性檢查

## 常見問題點

### 1. safeTransferFrom 未檢查接收者
```solidity
// ❌ 缺少 onERC1155Received 調用
function safeTransferFrom(...) {
    _transfer(from, to, id, amount);
    emit TransferSingle(operator, from, to, id, amount);
}
```

### 2. safeBatchTransferFrom 未檢查接收者
```solidity
// ❌ 缺少 onERC1155BatchReceived 調用
function safeBatchTransferFrom(...) {
    for (uint i = 0; i < ids.length; i++) {
        _transfer(from, to, ids[i], amounts[i]);
    }
    emit TransferBatch(operator, from, to, ids, amounts);
}
```

### 3. Mint 時未檢查
```solidity
// ❌ mint 時也應該檢查接收者
function _mint(address to, uint256 id, uint256 amount) internal {
    _balances[id][to] += amount;
    // 缺少接收者檢查
}
```

## 檢測方法

### 1. 搜尋轉移函數
```bash
grep -rn "safeTransferFrom\|safeBatchTransferFrom" contracts/ --include="*.sol"
```

### 2. 檢查是否有接收者回調
```bash
grep -rn "onERC1155Received\|onERC1155BatchReceived" contracts/ --include="*.sol"
```

### 3. 審計 Checklist
- [ ] `safeTransferFrom` 調用 `onERC1155Received`？
- [ ] `safeBatchTransferFrom` 調用 `onERC1155BatchReceived`？
- [ ] `_mint` 調用相應的接收者檢查？
- [ ] 正確處理回調返回值？

## 修復方式

### 直接使用 OpenZeppelin
```solidity
import "@openzeppelin/contracts/token/ERC1155/ERC1155.sol";

contract MyToken is ERC1155 {
    // 繼承自動獲得正確實現
}
```

### 手動實現
```solidity
function _doSafeTransferAcceptanceCheck(
    address operator,
    address from,
    address to,
    uint256 id,
    uint256 amount,
    bytes memory data
) private {
    if (to.code.length > 0) {
        try IERC1155Receiver(to).onERC1155Received(operator, from, id, amount, data) 
            returns (bytes4 response) 
        {
            if (response != IERC1155Receiver.onERC1155Received.selector) {
                revert("ERC1155: rejected");
            }
        } catch {
            revert("ERC1155: non-receiver");
        }
    }
}
```

## 真實案例

| 專案 | 位置 | 問題 | 影響 |
|------|------|------|------|
| Beanstalk 2024 | SiloFacet | 缺少接收者檢查 | Medium |

## 相關模式
- [erc721-compliance.md](./erc721-compliance.md) (待新增)
- [token-stuck.md](./token-stuck.md) (待新增)

## 標籤
`token` `erc1155` `compliance` `medium-severity`
