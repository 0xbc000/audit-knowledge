# Diamond Storage Collision (ERC-2535)

## 風險等級
**Critical** - 可能導致狀態損壞和資金損失

## 描述

ERC-2535 Diamond 模式使用特殊的儲存佈局來避免 Facet 之間的衝突。如果 Facet 沒有正確使用 Diamond Storage 模式，或者在升級時改變了儲存結構，可能導致嚴重的狀態損壞。

## Diamond Storage 模式

```solidity
// 標準 Diamond Storage 模式
library LibDiamond {
    bytes32 constant DIAMOND_STORAGE_POSITION = 
        keccak256("diamond.standard.diamond.storage");

    struct DiamondStorage {
        mapping(bytes4 => address) facetAddresses;
        // ... 其他狀態
    }

    function diamondStorage() internal pure returns (DiamondStorage storage ds) {
        bytes32 position = DIAMOND_STORAGE_POSITION;
        assembly {
            ds.slot := position
        }
    }
}
```

## 漏洞模式

### 類型 1: 直接狀態變數衝突

```solidity
// ❌ Facet A
contract FacetA {
    uint256 public valueA;  // slot 0
    uint256 public valueB;  // slot 1
}

// ❌ Facet B
contract FacetB {
    address public owner;   // slot 0 - 與 valueA 衝突！
    uint256 public balance; // slot 1 - 與 valueB 衝突！
}
```

### 類型 2: 升級時改變結構

```solidity
// 原始結構
struct AppStorage {
    uint256 a;  // slot 0
    uint256 b;  // slot 1
}

// ❌ 升級後插入新變數
struct AppStorage {
    uint256 a;      // slot 0
    uint256 newVar; // slot 1 ← 新增
    uint256 b;      // slot 2 ← 位移了！
}
```

### 類型 3: 繼承順序變化

```solidity
// 原始
contract Facet is A, B { }

// ❌ 升級後改變繼承順序
contract FacetV2 is B, A { }  // 儲存佈局可能改變
```

## Beanstalk 案例

```solidity
// Beanstalk 使用巨大的 AppStorage 結構 (~900 行)
// protocol/contracts/beanstalk/AppStorage.sol

contract AppStorage {
    Storage.Season season;
    Storage.Weather weather;
    Storage.Field f;
    Storage.Governance g;
    Storage.Oracle o;
    // ... 數百個變數
}

// 風險:
// 1. 任何插入都會導致後續變數位移
// 2. 需要非常小心地只在末尾添加
// 3. 移除變數需要用 gap 替代
```

## 影響

1. **狀態損壞** - 變數讀取/寫入錯誤的 slot
2. **餘額錯誤** - 用戶餘額被覆蓋或讀取錯誤
3. **權限問題** - admin 地址被覆蓋
4. **不可逆損害** - 可能無法恢復

## 檢測方法

### 1. 檢查 Facet 的狀態變數
```bash
# 找所有 Facet 的狀態變數
grep -rn "contract.*Facet" contracts/ -A 50 | grep -E "^\s+(uint|address|mapping|bool)"
```

### 2. 使用儲存佈局工具
```bash
# Foundry
forge inspect ContractName storage-layout

# Hardhat
npx hardhat storage-layout
```

### 3. 比較升級前後的佈局
```bash
# 保存舊佈局
forge inspect OldContract storage > old_layout.json

# 比較新佈局
forge inspect NewContract storage > new_layout.json
diff old_layout.json new_layout.json
```

## 修復方式

### 方案 1: 嚴格使用 AppStorage 模式

```solidity
// 所有 Facet 使用同一個 AppStorage
library LibAppStorage {
    bytes32 constant APP_STORAGE_POSITION = 
        keccak256("app.storage");
    
    function appStorage() internal pure returns (AppStorage storage s) {
        bytes32 position = APP_STORAGE_POSITION;
        assembly {
            s.slot := position
        }
    }
}

contract SomeFacet {
    // ❌ 不要在 Facet 中直接定義狀態變數
    // uint256 public myVar;
    
    // ✅ 通過 AppStorage 訪問
    function getMyVar() external view returns (uint256) {
        AppStorage storage s = LibAppStorage.appStorage();
        return s.myVar;
    }
}
```

### 方案 2: 升級時使用 Gap

```solidity
struct AppStorage {
    uint256 a;
    uint256 b;
    uint256[50] __gap;  // 預留空間
    uint256 c;
}

// 升級時使用 gap
struct AppStorageV2 {
    uint256 a;
    uint256 b;
    uint256 newVar;     // 使用 gap 的第一個 slot
    uint256[49] __gap;  // gap 減少 1
    uint256 c;
}
```

### 方案 3: 使用 DiamondStorage 隔離

```solidity
// 每個功能模組使用獨立的儲存位置
library LibGaugeStorage {
    bytes32 constant GAUGE_STORAGE = keccak256("gauge.storage");
    
    struct GaugeStorage {
        mapping(address => uint256) gaugePoints;
        // ...
    }
    
    function gaugeStorage() internal pure returns (GaugeStorage storage gs) {
        bytes32 position = GAUGE_STORAGE;
        assembly {
            gs.slot := position
        }
    }
}
```

## 審計 Checklist

- [ ] 所有 Facet 都使用 AppStorage/DiamondStorage？
- [ ] 沒有在 Facet 中直接定義狀態變數？
- [ ] 升級時只在結構末尾添加變數？
- [ ] 使用 gap 預留升級空間？
- [ ] 升級前後對比儲存佈局？

## 真實案例

| 專案 | 問題 | 影響 |
|------|------|------|
| Beanstalk | 巨大 AppStorage 結構 | 升級風險高 |
| 多個 Diamond 專案 | Facet 狀態變數衝突 | 狀態損壞 |

## 相關模式
- [proxy-upgrade.md](./proxy-upgrade.md) (待新增)
- [storage-layout.md](./storage-layout.md) (待新增)

## 標籤
`upgrade` `diamond` `erc2535` `storage` `critical-severity`
