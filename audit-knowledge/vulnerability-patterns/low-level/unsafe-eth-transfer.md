# 不安全的 ETH 轉帳 (Unsafe ETH Transfer)

## 類別
- **類型**: 低層調用漏洞
- **嚴重性**: Medium / High
- **常見於**: 任何需要發送 ETH 的合約

## 模式描述

使用 `.transfer()` 或 `.send()` 發送 ETH，而非 `.call{value: amount}("")`。這些方法有 2300 gas 限制，可能導致轉帳失敗。

## 漏洞特徵

```solidity
// ❌ 危險：2300 gas 限制
payable(recipient).transfer(amount);
// 或
bool success = payable(recipient).send(amount);

// ✅ 安全：無 gas 限制
(bool success, ) = payable(recipient).call{value: amount}("");
require(success, "Transfer failed");
```

## 為什麼 .transfer() 不安全

1. **Gas 限制**: `.transfer()` 只轉發 2300 gas
2. **合約接收者**: 如果接收者是合約，其 `receive()` 或 `fallback()` 可能需要更多 gas
3. **Gas 價格變化**: EIP-1884 後某些 opcode 變貴，2300 gas 可能不夠
4. **失敗處理**: `.transfer()` 失敗會 revert，可能導致 DoS

## 真實案例

### RAAC (2025-02 CodeHawks)

**檔案**: `NFTLiquidator.sol`

```solidity
function placeBid(uint256 tokenId) external payable {
    // ...
    if (data.highestBidder != address(0)) {
        // ❌ 如果 highestBidder 是合約，可能失敗
        payable(data.highestBidder).transfer(data.highestBid);
    }
}

function endAuction(uint256 tokenId) external {
    // ...
    // ❌ 如果 stabilityPool 的 receive() 需要 >2300 gas，失敗
    payable(stabilityPool).transfer(winningBid);
}

function buyBackNFT(uint256 tokenId) external payable {
    // ❌ 多次不安全轉帳
    payable(data.highestBidder).transfer(data.highestBid);
    payable(stabilityPool).transfer(price);
    payable(msg.sender).transfer(msg.value - price);
}
```

**影響**:
- 拍賣可能無法結束（DoS）
- 用戶資金可能被鎖定
- 合約功能失效

## 正確實現

```solidity
function sendETH(address payable recipient, uint256 amount) internal {
    (bool success, ) = recipient.call{value: amount}("");
    require(success, "ETH transfer failed");
}

// 更安全：使用 OpenZeppelin Address 庫
import "@openzeppelin/contracts/utils/Address.sol";

function sendETH(address payable recipient, uint256 amount) internal {
    Address.sendValue(recipient, amount);
}
```

## 常見受害者

1. **多簽錢包**: Gnosis Safe 等需要執行邏輯
2. **智能合約錢包**: 如 Argent
3. **有 fallback 邏輯的合約**: 如自動記錄的合約

## 檢測方法

### 1. 靜態分析

```bash
grep -rn "\.transfer(\|\.send(" contracts/ --include="*.sol"
```

### 2. Slither

```bash
slither . --detect low-level-calls
```

### 3. Prompt Template

```markdown
## ETH 轉帳安全分析

合約中的 ETH 轉帳：
[貼上程式碼]

## 檢查
1. 使用的是 .transfer()/.send() 還是 .call()？
2. 接收者可能是合約嗎？
3. 如果轉帳失敗會發生什麼？
4. 是否有 DoS 風險？
```

## 相關漏洞
- [Denial of Service](../dos/transfer-dos.md)
- [Failed Transfer Not Handled](./unchecked-return.md)

## 標籤
`eth-transfer` `low-level` `medium-severity` `dos`
