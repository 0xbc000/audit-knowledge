# 拍賣首次出價漏洞 (Auction First Bid Vulnerability)

## 類別
- **類型**: 業務邏輯漏洞
- **嚴重性**: Medium / High
- **常見於**: 拍賣系統、NFT 市場

## 模式描述

拍賣系統在計算最低出價時，沒有考慮首次出價的情況，導致第一個出價可以是任意小的金額。

## 漏洞特徵

```solidity
// ❌ 錯誤：首次出價無最低限制
function placeBid(uint256 tokenId) external payable {
    TokenData storage data = tokenData[tokenId];
    
    // 當 highestBid = 0 時，minBidAmount = 0 + 0 = 0
    uint256 minBidAmount = data.highestBid + 
        (data.highestBid * minBidIncreasePercentage / 100);
    
    // 所以首次出價只需 > 0，即 1 wei 即可
    if (msg.value <= minBidAmount) revert BidTooLow(minBidAmount);
}

// ✅ 正確：設定起始價格
function placeBid(uint256 tokenId) external payable {
    TokenData storage data = tokenData[tokenId];
    
    uint256 minBidAmount;
    if (data.highestBid == 0) {
        minBidAmount = data.startingPrice;  // 使用起始價格
    } else {
        minBidAmount = data.highestBid + 
            (data.highestBid * minBidIncreasePercentage / 100);
    }
    
    if (msg.value < minBidAmount) revert BidTooLow(minBidAmount);
}
```

## 真實案例

### RAAC (2025-02 CodeHawks)

**檔案**: `NFTLiquidator.sol` → `placeBid()` (Line 118-134)

```solidity
function placeBid(uint256 tokenId) external payable {
    TokenData storage data = tokenData[tokenId];
    if (block.timestamp >= data.auctionEndTime) revert AuctionHasEnded();
    
    // ❌ 問題在這裡
    uint256 minBidAmount = data.highestBid + 
        (data.highestBid * minBidIncreasePercentage / 100);
    // 當 highestBid = 0:
    // minBidAmount = 0 + (0 * 10 / 100) = 0
    
    if (msg.value <= minBidAmount) revert BidTooLow(minBidAmount);
    // msg.value > 0 即可通過，1 wei 就行
}
```

**攻擊場景**:
1. NFT 被清算，債務為 100 ETH
2. 拍賣開始，無人出價
3. 攻擊者出價 1 wei
4. 成為 highestBidder
5. 如果無人競爭，1 wei 買走價值 100 ETH 的 NFT

## 檢測方法

### 1. 檢查起始條件

```bash
# 搜索拍賣相關代碼
grep -rn "placeBid\|startingPrice\|minBid" contracts/
```

### 2. 數學分析

對於任何計算 minBid 的公式，代入初始值（0）看結果：
- `minBid = highestBid * (1 + percentage)` → 當 highestBid=0，minBid=0
- `minBid = max(startingPrice, highestBid * ...)` → 安全

### 3. Prompt Template

```markdown
## 拍賣邏輯分析

出價函數：
[貼上程式碼]

## 問題
1. 首次出價的最低金額是多少？
2. 如果 highestBid = 0，計算結果是什麼？
3. 攻擊者可以用多少 ETH 成為首個出價者？
4. 起始價格/債務是否被用作底價？
```

## 修復方式

```solidity
struct TokenData {
    uint256 debt;           // 債務金額
    uint256 startingPrice;  // 起始價格 = debt 或更高
    uint256 auctionEndTime;
    uint256 highestBid;
    address highestBidder;
}

function liquidateNFT(uint256 tokenId, uint256 debt) external {
    tokenData[tokenId] = TokenData({
        debt: debt,
        startingPrice: debt,  // 至少要等於債務
        auctionEndTime: block.timestamp + 3 days,
        highestBid: 0,
        highestBidder: address(0)
    });
}

function placeBid(uint256 tokenId) external payable {
    TokenData storage data = tokenData[tokenId];
    
    uint256 minBidAmount;
    if (data.highestBid == 0) {
        // 首次出價必須 >= 起始價格
        minBidAmount = data.startingPrice;
    } else {
        minBidAmount = data.highestBid + 
            (data.highestBid * minBidIncreasePercentage / 100);
    }
    
    require(msg.value >= minBidAmount, "Bid too low");
    // ...
}
```

## 相關漏洞
- [Zero Value Edge Cases](./zero-value-edge-cases.md)
- [Missing Input Validation](./missing-validation.md)

## 標籤
`auction` `business-logic` `first-bid` `edge-case` `medium-severity`
