# 權重分配錯誤 (Weight Distribution Error)

## 類別
- **類型**: 業務邏輯漏洞
- **嚴重性**: High / Critical
- **常見於**: Vault 系統、Staking、Credit Delegation

## 模式描述

當系統需要將資源（credit、rewards、weight）分配給多個接收者時，錯誤地將**全部資源**分配給**每個**接收者，而不是按比例分配。

## 漏洞特徵

```solidity
// ❌ 錯誤模式
uint256 totalAssets = getTotalAssets();

for (uint i = 0; i < receivers.length; i++) {
    receivers[i].allocation = totalAssets;  // 每個都拿到 100%
}

// ✅ 正確模式
uint256 totalAssets = getTotalAssets();
uint256 perReceiver = totalAssets / receivers.length;

for (uint i = 0; i < receivers.length; i++) {
    receivers[i].allocation = perReceiver;  // 按比例分配
}
```

## 真實案例

### Zaros (2025-01 CodeHawks)

**檔案**: `src/market-making/leaves/Vault.sol`
**函數**: `updateVaultAndCreditDelegationWeight`

```solidity
function updateVaultAndCreditDelegationWeight(...) internal {
    uint128 newWeight = uint128(IERC4626(self.indexToken).totalAssets());

    for (uint256 i; i < connectedMarketsIdsCache.length; i++) {
        // ❌ 每個 market 都拿到全部權重
        creditDelegation.weight = newWeight;
    }

    self.totalCreditDelegationWeight = newWeight;
}
```

**影響**:
- 2 個 markets → 200% 總分配
- 導致 over-leveraging
- 可能造成協議 insolvency

## 檢測方法

### 1. 靜態分析關鍵字
- `for` loop + assignment 在 loop 內
- 變數名包含: weight, share, allocation, distribution
- 沒有除法運算

### 2. Invariant 檢查
```solidity
// 總分配應該等於總資源
assert(sum(allocations) == totalResources);

// 或者總比例應該 = 100%
assert(sum(shares) == 1e18);
```

### 3. Prompt Template
```markdown
## 分析這個分配函數

[貼上程式碼]

## 問題
1. 假設有 N 個接收者，每個會收到多少？
2. 所有接收者的總和是多少？
3. 這個總和應該等於什麼？
4. 是否有 over-allocation 風險？
```

## 修復方式

```solidity
function updateVaultAndCreditDelegationWeight(...) internal {
    uint128 totalWeight = uint128(IERC4626(self.indexToken).totalAssets());
    uint128 numMarkets = uint128(connectedMarketsIdsCache.length);
    
    // ✅ 按比例分配
    uint128 weightPerMarket = totalWeight / numMarkets;

    for (uint256 i; i < connectedMarketsIdsCache.length; i++) {
        creditDelegation.weight = weightPerMarket;
    }

    self.totalCreditDelegationWeight = totalWeight;
}
```

## 相關漏洞
- [Reward Distribution Errors](./reward-distribution-error.md)
- [Share Calculation Errors](./share-calculation-error.md)

## 標籤
`business-logic` `math` `distribution` `high-severity`
