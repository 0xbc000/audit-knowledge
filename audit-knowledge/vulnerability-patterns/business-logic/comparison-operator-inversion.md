# 比較運算符反轉 (Comparison Operator Inversion)

## 類別
- **類型**: 業務邏輯漏洞
- **嚴重性**: High / Critical
- **常見於**: 條件分支、狀態轉換、結算邏輯

## 模式描述

在條件判斷中使用了錯誤的比較運算符（`<` vs `>`、`<=` vs `>=`），導致邏輯完全相反。

## 漏洞特徵

```solidity
// ❌ 錯誤：運算符反了
if (debt < 0) {
    // 應該在 debt > 0 時執行
    sellAssetsForUSDC();
}

// ✅ 正確
if (debt > 0) {
    sellAssetsForUSDC();  // 有債務時賣資產還債
}
```

## 真實案例

### Zaros (2025-01 CodeHawks)

**檔案**: `src/market-making/branches/CreditDelegationBranch.sol`
**函數**: `settleVaultDebts`

```solidity
// 業務邏輯：
// debt > 0: vault 欠債，需要賣 collateral 換 USDC
// debt < 0: vault 有餘額，需要賣 USDC 換 collateral

// ❌ 錯誤程式碼
if (ctx.vaultUnsettledRealizedDebtUsdX18.lt(SD59x18_ZERO)) {
    // 這裡執行 "swap assets to USDC"
    // 但 .lt(ZERO) 表示 debt < 0，應該是反過來的操作！
}

// ✅ 正確應該是
if (ctx.vaultUnsettledRealizedDebtUsdX18.gt(SD59x18_ZERO)) {
    // debt > 0 時才需要賣資產換 USDC
}
```

**影響**:
- 結算邏輯完全相反
- 有債務時反而增加債務
- 有餘額時反而減少餘額
- 協議財務狀況持續惡化

## 檢測方法

### 1. 語義分析
找到條件分支，問：
- 「當 X > 0 時應該做什麼？」
- 「當 X < 0 時應該做什麼？」
- 「程式碼的條件和動作匹配嗎？」

### 2. 命名對照
```solidity
// 看函數/變數名稱是否與操作匹配
if (isInDebt) {
    reduceCredit();  // ❌ 有債務時應該還債，不是減少信用
}
```

### 3. Prompt Template
```markdown
## 業務邏輯
[描述這個函數要做什麼]

- 條件 A 時應該執行動作 X
- 條件 B 時應該執行動作 Y

## 程式碼
[貼上程式碼]

## 驗證
1. 程式碼中的條件是什麼？
2. 在該條件下執行的動作是什麼？
3. 這個動作與業務邏輯匹配嗎？
4. 比較運算符是否正確？
```

## 常見變體

### 1. 直接運算符錯誤
```solidity
if (a < b) // 應該是 a > b
```

### 2. 方法調用錯誤
```solidity
if (x.lt(y))  // 應該是 x.gt(y)
if (x.lte(y)) // 應該是 x.gte(y)
```

### 3. 邊界條件錯誤
```solidity
if (balance >= minRequired) // 應該是 balance > minRequired
```

### 4. 否定邏輯錯誤
```solidity
if (!isValid) // 應該是 if (isValid)
```

## 預防措施

1. **寫清晰的註釋說明業務邏輯**
```solidity
// When in debt (> 0), sell collateral for USDC
// When in credit (< 0), sell USDC for collateral
if (debt.gt(ZERO)) {
    sellCollateralForUSDC();
}
```

2. **使用有意義的變數名**
```solidity
bool isInDebt = debt.gt(ZERO);
if (isInDebt) {
    sellCollateralForUSDC();
}
```

3. **單元測試覆蓋兩個分支**
```solidity
function test_settleDebt_whenInDebt() { ... }
function test_settleDebt_whenInCredit() { ... }
```

## 標籤
`business-logic` `comparison` `operator` `high-severity` `easy-to-miss`
