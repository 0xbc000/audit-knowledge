# Gas Griefing in Cross-Chain Messaging

## 問題描述

跨鏈訊息（如 LayerZero）需要指定目標鏈執行的 gas 量。如果用戶可以控制這個值，攻擊者可以：
1. 傳入過低的 gas → 目標鏈 out-of-gas
2. 訊息狀態變為 `STORED`
3. 阻塞整個跨鏈 channel

## 漏洞模式

```solidity
// ❌ 危險：用戶完全控制 gas
function bridge(uint64 _dstGasForCall) public {
    uint256 gasAmount = GAS_FOR_RELAY + _dstGasForCall;  // 用戶控制
    // ... send cross-chain message
}

// ❌ 危險：硬編碼過低的值
uint256 GAS_FOR_RELAY = 100000;  // 對某些鏈不夠
```

## LayerZero 建議值

| 鏈 | 最低 Gas |
|----|----------|
| EVM (大多數) | 200,000 |
| Arbitrum | 2,000,000 |

## 安全模式

```solidity
// ✅ 強制最低 gas
uint256 public constant MIN_DST_GAS = 200000;

function bridge(uint64 _dstGasForCall) public {
    require(_dstGasForCall >= MIN_DST_GAS, "Gas too low");
    // ...
}

// ✅ 按鏈設定
mapping(uint16 => uint256) public minGasLookup;

function setMinGas(uint16 chainId, uint256 minGas) external onlyOwner {
    minGasLookup[chainId] = minGas;
}
```

## 完整 Exploit Path

### 前置條件
1. 目標合約使用 LayerZero / Axelar 等跨鏈通訊
2. 用戶可控制 `dstGasForCall` 或 `adapterParams` 中的 gas 值
3. 目標鏈上有非 trivial 的 execution logic

### 攻擊步驟
```
1. 攻擊者呼叫 bridge() 並設定 _dstGasForCall = 1（極低值）
2. Source chain 扣取費用、鎖定資金、發送跨鏈訊息
3. Destination chain relayer 嘗試執行，因 gas 不足 → revert
4. LayerZero: 訊息進入 STORED 狀態 → 同 src→dst path 的後續訊息被阻塞
5. 直到有人手動 retry（以足夠 gas）才能解除阻塞
```

### 成功斷言（Foundry）
```solidity
function test_gasGriefingBlocksChannel() public {
    // Step 1: Send message with insufficient gas
    vm.prank(attacker);
    bridge.send{value: fee}(dstChainId, payload, 1); // 1 gas

    // Step 2: Verify message is stored (not executed)
    bytes32 msgHash = endpoint.storedPayload(srcChainId, srcAddress);
    assertTrue(msgHash != bytes32(0), "Message should be stored (blocked)");

    // Step 3: Try sending another message — should also be blocked
    vm.prank(legitimateUser);
    vm.expectRevert("LayerZero: in]blocking");
    bridge.send{value: fee}(dstChainId, payload2, 200000);
}
```

### 失敗斷言（修復後）
```solidity
function test_minGasEnforced() public {
    vm.prank(attacker);
    vm.expectRevert("Gas too low");
    bridge.send{value: fee}(dstChainId, payload, 1);
}
```

## 受影響協議

- Decent Bridge (H-02) - 2024-01

## 檢查清單

- [ ] 用戶是否能控制目標鏈 gas？
- [ ] 是否有最低 gas 要求？
- [ ] 不同目標鏈的 gas 需求是否不同？
- [ ] 單筆訊息失敗是否會阻塞 channel？
