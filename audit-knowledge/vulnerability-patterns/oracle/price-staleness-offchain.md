# 離鏈價格數據過期風險 (Offchain Price Staleness)

## 類別
- **類型**: Oracle 漏洞
- **嚴重性**: High
- **常見於**: 使用簽名價格數據的 DEX、永續合約

## 模式描述

協議接受離鏈簽名的價格數據，但未驗證該數據的時間戳，導致可以使用過期價格執行交易。

## 與傳統 Oracle 過期的區別

| 類型 | 傳統 Oracle | 離鏈簽名價格 |
|------|------------|-------------|
| 數據來源 | 鏈上 Oracle 合約 | 離鏈簽名者（Keeper） |
| 過期原因 | Oracle 未更新 | 使用舊的簽名數據 |
| 攻擊者 | 被動利用 | 主動選擇有利價格 |

## 漏洞特徵

```solidity
// ❌ 錯誤：未驗證價格數據時間戳
function fulfillSwap(
    address user,
    uint128 requestId,
    bytes calldata priceData,  // 簽名的價格數據
    address engine
) external onlyRegisteredSystemKeepers {
    // 只檢查請求是否過期
    if (request.deadline < block.timestamp) {
        revert SwapRequestExpired();
    }
    
    // 驗證簽名但不驗證時間戳！
    ctx.priceX18 = stabilityConfiguration.verifyOffchainPrice(priceData);
    
    // 使用可能過期的價格執行 swap
    ctx.amountOut = getAmountOfAssetOut(..., ctx.priceX18);
}

// ✅ 正確：驗證價格數據時間戳
function fulfillSwap(
    address user,
    uint128 requestId,
    bytes calldata priceData,
    address engine
) external onlyRegisteredSystemKeepers {
    (uint256 price, uint256 priceTimestamp) = 
        stabilityConfiguration.verifyOffchainPrice(priceData);
    
    // 驗證價格數據新鮮度
    if (block.timestamp - priceTimestamp > MAX_PRICE_AGE) {
        revert StalePriceData();
    }
    
    ctx.amountOut = getAmountOfAssetOut(..., price);
}
```

## 真實案例

### Zaros (2025-01 CodeHawks)

**檔案**: `StabilityBranch.sol` → `fulfillSwap`

```solidity
function fulfillSwap(
    address user,
    uint128 requestId,
    bytes calldata priceData,
    address engine
) external onlyRegisteredSystemKeepers {
    // ...
    
    // ⚠️ 只驗證簽名，不驗證時間戳
    ctx.priceX18 = stabilityConfiguration.verifyOffchainPrice(priceData);
    
    // 使用價格計算輸出金額
    ctx.amountOutBeforeFeesX18 = getAmountOfAssetOut(
        ctx.vaultId, 
        ud60x18(ctx.amountIn), 
        ctx.priceX18
    );
}
```

**攻擊場景**:
1. 用戶 A 發起 swap 請求（價格 = $100）
2. 價格變動到 $150
3. Keeper 可以選擇使用舊價格（$100）或新價格（$150）
4. 根據對誰有利，選擇對應的價格數據

## 檢測方法

### 1. 檢查簽名驗證函數

```bash
grep -rn "verifyOffchainPrice\|verifySignature\|priceData" contracts/
```

確認是否返回並檢查時間戳。

### 2. Prompt Template

```markdown
## 離鏈價格數據分析

這個函數使用簽名的價格數據：
[貼上程式碼]

## 檢查
1. 價格數據是否包含時間戳？
2. 時間戳是否被驗證？
3. 允許的最大過期時間是多少？
4. 誰可以提供價格數據？他們有動機選擇有利價格嗎？
```

## 修復方式

```solidity
struct PriceData {
    uint256 price;
    uint256 timestamp;
    bytes signature;
}

function fulfillSwap(..., bytes calldata priceData) external {
    PriceData memory data = abi.decode(priceData, (PriceData));
    
    // 1. 驗證簽名
    require(verifySignature(data), "Invalid signature");
    
    // 2. 驗證時間戳
    require(
        block.timestamp - data.timestamp <= MAX_PRICE_AGE,
        "Stale price"
    );
    
    // 3. 可選：檢查價格偏差
    require(
        isPriceWithinRange(data.price, getOraclePrice()),
        "Price deviation too high"
    );
    
    // 4. 使用價格
    executeSwap(data.price);
}
```

## 相關漏洞
- [Oracle Staleness (Onchain)](./oracle-staleness.md)
- [Keeper Manipulation](../keeper/keeper-manipulation.md)

## 標籤
`oracle` `offchain` `staleness` `signature` `high-severity`
