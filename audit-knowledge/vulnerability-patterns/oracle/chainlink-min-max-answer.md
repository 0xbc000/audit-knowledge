# Chainlink Min/Max Answer 未檢查 (Chainlink Circuit Breaker)

## 風險等級
**High** - 極端市場條件下可能導致嚴重資金損失

## 描述

Chainlink 價格 feed 有內建的 `minAnswer` 和 `maxAnswer` 限制（circuit breaker）。當實際價格超出這個範圍時，Oracle 會返回邊界值而非實際價格。如果協議沒有檢查這種情況，可能在極端市場條件下使用錯誤價格。

## 技術背景

```solidity
// Chainlink Aggregator 有價格邊界
// 例如 ETH/USD:
// minAnswer = $100 (防止報價過低)
// maxAnswer = $100,000 (防止報價過高)

// 當實際價格 = $50 時:
// Oracle 返回 minAnswer = $100
// 協議以為 ETH = $100，實際 = $50
```

## 漏洞模式

```solidity
// ❌ Beanstalk - LibChainlinkOracle.sol
function getEthUsdPrice() internal view returns (uint256 price) {
    try priceAggregator.latestRoundData() returns (
        uint80 roundId,
        int256 answer,
        uint256,
        uint256 timestamp,
        uint80
    ) {
        if (roundId == 0) return 0;
        if (timestamp == 0 || timestamp > block.timestamp) return 0;
        if (block.timestamp - timestamp > CHAINLINK_TIMEOUT) return 0;
        if (answer <= 0) return 0;
        
        // ❌ 沒有檢查 answer 是否等於 minAnswer 或 maxAnswer
        return uint256(answer).mul(PRECISION).div(10 ** decimals);
    }
}
```

## 真實案例: Venus/LUNA (2022)

```
1. LUNA 價格崩盤至 $0.01 以下
2. Chainlink minAnswer = $0.10
3. Venus 協議使用 $0.10 作為 LUNA 價格
4. 用戶以 10x 高估的價格抵押 LUNA
5. 借出大量穩定幣
6. 協議損失數百萬美元
```

## 影響

1. **錯誤清算** - 價格崩盤時不觸發清算
2. **超額借貸** - 用已崩盤的資產借出正常資產
3. **套利** - 利用協議價格和真實價格的差異

## 檢測方法

### 1. 找 Oracle 使用
```bash
grep -rn "latestRoundData\|getEthUsdPrice" contracts/ --include="*.sol"
```

### 2. 檢查是否有 minAnswer/maxAnswer 驗證
```solidity
// 缺少這類檢查就是漏洞
if (answer >= maxAnswer || answer <= minAnswer) {
    revert("Price at circuit breaker");
}
```

### 3. 查詢 Chainlink Feed 的邊界
```solidity
// 可以從 aggregator 獲取
int192 minAnswer = IChainlinkAggregator(feed).minAnswer();
int192 maxAnswer = IChainlinkAggregator(feed).maxAnswer();
```

## 修復方式

### 方案 1: 直接檢查邊界
```solidity
function getPrice() internal view returns (uint256) {
    (, int256 answer, , uint256 timestamp, ) = priceFeed.latestRoundData();
    
    // 獲取 feed 的邊界
    int192 minAnswer = priceFeed.minAnswer();
    int192 maxAnswer = priceFeed.maxAnswer();
    
    // 檢查是否觸及邊界
    if (answer <= int256(minAnswer) || answer >= int256(maxAnswer)) {
        revert("Price at circuit breaker limit");
    }
    
    return uint256(answer);
}
```

### 方案 2: 多源驗證
```solidity
function getPrice() internal view returns (uint256) {
    uint256 chainlinkPrice = getChainlinkPrice();
    uint256 uniswapTwap = getUniswapTwap();
    
    // 如果差異過大，可能是 circuit breaker 觸發
    uint256 deviation = calculateDeviation(chainlinkPrice, uniswapTwap);
    if (deviation > MAX_ALLOWED_DEVIATION) {
        revert("Price sources diverge - possible circuit breaker");
    }
    
    return chainlinkPrice;
}
```

### 方案 3: 熔斷機制
```solidity
// 當檢測到異常時暫停協議
modifier priceValid() {
    if (isPriceAtCircuitBreaker()) {
        _pause();
        revert("Protocol paused due to extreme price");
    }
    _;
}
```

## 常見邊界值

| Feed | minAnswer | maxAnswer |
|------|-----------|-----------|
| ETH/USD | ~$100 | ~$100,000 |
| BTC/USD | ~$1,000 | ~$1,000,000 |
| LINK/USD | ~$0.01 | ~$10,000 |

*注意：這些值可能會更新，需要查詢實際 feed*

## 審計 Checklist

- [ ] 協議是否檢查 `minAnswer`/`maxAnswer`？
- [ ] 極端價格時的行為是否安全？
- [ ] 是否有多源價格驗證？
- [ ] 是否有緊急暫停機制？

## 真實案例

| 專案 | 年份 | 問題 | 損失 |
|------|------|------|------|
| Venus | 2022 | LUNA circuit breaker | 數百萬 |
| Blizz Finance | 2022 | 同樣問題 | 數百萬 |
| Beanstalk | 2024 | 未檢查 minAnswer | Medium |

## 相關模式
- [oracle-staleness.md](./oracle-staleness.md)
- [chainlink-phase-id.md](./chainlink-phase-id.md)

## 標籤
`oracle` `chainlink` `circuit-breaker` `high-severity` `luna`
