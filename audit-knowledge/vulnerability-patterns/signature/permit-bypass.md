# ERC20 Permit / Permit2 Vulnerabilities

## 風險等級
**High** — 可導致未授權 token 轉移

## 描述

ERC20 Permit（EIP-2612）和 Uniswap Permit2 允許用簽名授權 token 支出，避免兩步 approve+transfer。但有多個攻擊面。

## 漏洞模式

### 模式 1: Permit 前置 — 搶先使用他人的 Permit 簽名

```solidity
// ❌ VULNERABLE — 如果 permit 被搶先執行，後續交易 revert
function depositWithPermit(uint256 amount, uint256 deadline, uint8 v, bytes32 r, bytes32 s) external {
    token.permit(msg.sender, address(this), amount, deadline, v, r, s);
    token.transferFrom(msg.sender, address(this), amount);
}
// 攻擊: Eve 從 mempool 看到 Alice 的 tx，先用相同 permit 調用 token.permit()
// Alice 的 tx 在 permit() 處 revert（nonce 已用），整筆交易失敗

// ✅ FIXED — try/catch permit，如果已被執行就跳過
function depositWithPermit(uint256 amount, uint256 deadline, uint8 v, bytes32 r, bytes32 s) external {
    try token.permit(msg.sender, address(this), amount, deadline, v, r, s) {} catch {}
    token.transferFrom(msg.sender, address(this), amount);
}
```

### 模式 2: Permit Deadline 未強制執行

```solidity
// ❌ VULNERABLE — 忽略 deadline
function executeWithPermit(
    address owner, uint256 amount, uint256 deadline,
    uint8 v, bytes32 r, bytes32 s
) external {
    // permit 裡有 deadline 檢查，但如果合約自己實作 permit...
    // 忘記檢查 deadline
    _approve(owner, msg.sender, amount);
}
```

### 模式 3: Permit2 AllowanceTransfer 金額未清零

```solidity
// ❌ VULNERABLE — Permit2 approve 後，allowance 可能一直有效
permit2.permit(owner, permitSingle, signature);
permit2.transferFrom(owner, recipient, amount, token);
// 如果 permitSingle.amount > 實際轉帳 amount
// 剩餘 allowance 可被再次使用

// ✅ FIXED — 用 SignatureTransfer（一次性）或確保 amount 精確
```

### 模式 4: Permit 用於非預期的 Spender

```solidity
// ❌ VULNERABLE — 用戶給合約 A 簽 permit，但 spender 填了 address(this)
// 如果 A 被攻擊或是惡意合約，可以用 permit 搶走用戶的 token
// 檢查: permit 的 spender 是否就是 msg.sender 或預期的目標合約
```

## 真實案例

### OpenSea Permit 前置攻擊 (2023)
- 用戶的 permit 簽名從 mempool 被提取
- 攻擊者先執行 permit，受害者交易 revert
- DoS 而非直接資金損失，但搭配其他漏洞可以 drain

### Sushi RouteProcessor3 (2023)
- 已授權過 Permit2 的用戶可被 drain
- 損失 $3.3M

## 檢測方法

```bash
# 找 permit 相關調用
grep -rn "\.permit(\|permit2\|PERMIT_TYPEHASH\|nonces" contracts/ --include="*.sol"

# 檢查是否有 try/catch 保護
grep -A5 "\.permit(" contracts/ --include="*.sol" | grep -c "try\|catch"
```

## 審計 Checklist

- [ ] Permit 調用是否用 try/catch 包裝？（防前置攻擊）
- [ ] Deadline 是否被合約強制檢查？
- [ ] Permit2 allowance 是否精確設定（不留殘餘）？
- [ ] Spender 是否限定為預期地址？
- [ ] 是否考慮不支持 permit 的 token（如 USDT）？

## 標籤
`signature` `permit` `permit2` `erc2612` `frontrunning` `high-severity`
