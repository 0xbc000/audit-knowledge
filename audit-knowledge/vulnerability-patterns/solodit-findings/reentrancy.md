# Reentrancy Findings (Solodit)

> Re-entrancy vulnerabilities including cross-function and read-only variants

## Overview

| ID | Severity | Title | Platform |
|----|----------|-------|----------|
| SOL-001 | ðŸ”´ critical | Cross-function Reentrancy in Withdrawal | Code4rena |
| SOL-002 | ðŸŸ  high | Read-Only Reentrancy via Balancer Pool | Sherlock |
| SOL-021 | ðŸ”´ critical | ERC721 onERC721Received Callback Reentrancy | Code4rena |
| SOL-022 | ðŸŸ  high | ERC1155 Batch Callback Reentrancy | Sherlock |
| SOL-023 | ðŸ”´ critical | Reentrancy Guard Reset in receive() | Code4rena |
| SOL-055 | ðŸŸ  high | Stake and Claim in Same Transaction | Sherlock |
| SOL-056 | ðŸ”´ critical | NFT Rental Hijack via ERC721 Callback | Code4rena |

---

## SOL-001: Cross-function Reentrancy in Withdrawal

**Severity:** ðŸ”´ CRITICAL  
**Platform:** Code4rena  
**Protocol Type:** DeFi Protocol

### Description
The withdraw() function makes an external call to transfer ETH before updating the user's balance, allowing recursive calls.

### Impact
Attacker can drain all funds from the contract.

### Vulnerable Code
```solidity
function withdraw(uint256 amount) external {
    require(balances[msg.sender] >= amount);
    (bool success,) = msg.sender.call{value: amount}("");  // External call
    require(success);
    balances[msg.sender] -= amount;  // State update AFTER call
}
```

### Fix
```solidity
function withdraw(uint256 amount) external nonReentrant {
    require(balances[msg.sender] >= amount);
    balances[msg.sender] -= amount;  // State update BEFORE call
    (bool success,) = msg.sender.call{value: amount}("");
    require(success);
}
```

---

## SOL-002: Read-Only Reentrancy via Balancer Pool

**Severity:** ðŸŸ  HIGH  
**Platform:** Sherlock  
**Protocol Type:** Lending Protocol

### Description
Protocol reads pool token price from Balancer during callback, but Balancer's invariants are temporarily violated during swaps.

### Impact
Attacker can manipulate perceived collateral value during liquidation.

### Vulnerable Code
```solidity
function getCollateralValue() external view returns (uint256) {
    // This reads manipulated price during callback
    return balancerPool.getRate() * userBalance;
}
```

### Fix
```solidity
function getCollateralValue() external view returns (uint256) {
    // Use TWAP or check Balancer's reentrancy lock
    require(!balancerVault.isLocked(), "Reentrancy detected");
    return balancerPool.getRate() * userBalance;
}
```

---

## SOL-021: ERC721 onERC721Received Callback Reentrancy

**Severity:** ðŸ”´ CRITICAL  
**Platform:** Code4rena  
**Protocol Type:** NFT Marketplace

### Description
Minting or transferring NFTs triggers onERC721Received callback before state is updated.

### Impact
Attacker can mint unlimited NFTs or manipulate auction state.

### Vulnerable Code
```solidity
function mint(address to) external {
    _safeMint(to, tokenId);  // Callback before state update
    totalMinted++;
}
```

### Fix
```solidity
function mint(address to) external nonReentrant {
    totalMinted++;  // State first
    _safeMint(to, tokenId);
}
```

---

## SOL-022: ERC1155 Batch Callback Reentrancy

**Severity:** ðŸŸ  HIGH  
**Platform:** Sherlock  
**Protocol Type:** Gaming Protocol

### Description
ERC1155 safeBatchTransferFrom triggers callback that can re-enter during multi-token transfer.

### Impact
Attacker can receive extra tokens or manipulate game state.

### Vulnerable Code
```solidity
function batchTransfer(address to, uint256[] ids, uint256[] amounts) external {
    for (uint i = 0; i < ids.length; i++) {
        balances[msg.sender][ids[i]] -= amounts[i];
    }
    _safeBatchTransferFrom(msg.sender, to, ids, amounts, "");  // Callback
}
```

### Fix
```solidity
// Use checks-effects-interactions or nonReentrant
```

---

## SOL-023: Reentrancy Guard Reset in receive()

**Severity:** ðŸ”´ CRITICAL  
**Platform:** Code4rena  
**Protocol Type:** Wise Lending

### Description
Native token receive() function resets reentrancy guard, allowing re-entry through ETH transfer.

### Impact
Complete bypass of reentrancy protection.

### Vulnerable Code
```solidity
receive() external payable {
    _sendingProgress = false;  // Resets guard!
}
```

### Fix
```solidity
// Never reset reentrancy state in receive()
// Use separate tracking for ETH flows
```

---

## SOL-055: Stake and Claim in Same Transaction

**Severity:** ðŸŸ  HIGH  
**Platform:** Sherlock  
**Protocol Type:** Staking Protocol

### Description
User can stake and immediately claim rewards in same block.

### Impact
New stakers dilute existing stakers immediately.

### Vulnerable Code
```solidity
function stake(uint256 amount) external {
    _updateReward(msg.sender);  // Gets full pending rewards
    stakedBalance[msg.sender] += amount;
}
```

### Fix
```solidity
// Use checkpoint that excludes current block rewards
```

---

## SOL-056: NFT Rental Hijack via ERC721 Callback

**Severity:** ðŸ”´ CRITICAL  
**Platform:** Code4rena  
**Protocol Type:** NFT Rental

### Description
Rental period extended during onERC721Received callback.

### Impact
Renter keeps NFT indefinitely by extending during return.

### Vulnerable Code
```solidity
function endRental() external {
    _safeTransfer(nft, renter, owner, tokenId);  // Callback to renter
    delete rentals[tokenId];  // State update after callback
}
```

### Fix
```solidity
// Update state before transfer
```

---


*Imported from Solodit curated findings*
