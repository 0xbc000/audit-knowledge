# Oracle Findings (Solodit)

> Oracle-related vulnerabilities including price manipulation and staleness

## Overview

| ID | Severity | Title | Platform |
|----|----------|-------|----------|
| SOL-003 | ðŸ”´ critical | TWAP Calculation Always Equals Spot Price | Internal Audit |
| SOL-004 | ðŸŸ  high | Stale Chainlink Price Not Checked | Code4rena |
| SOL-005 | ðŸŸ  high | Missing minAnswer/maxAnswer Check | Sherlock |
| SOL-024 | ðŸŸ  high | L2 Sequencer Downtime Not Checked | Sherlock |
| SOL-025 | ðŸŸ¡ medium | Hardcoded Oracle Decimals | Code4rena |
| SOL-026 | ðŸŸ  high | Uniswap V3 TWAP Manipulation via Low Liquidity | Sherlock |
| SOL-049 | ðŸ”´ critical | Curve LP Token Price Manipulation | Sherlock |
| SOL-051 | ðŸ”´ critical | Liquidation at Stale Price During Flash Crash | Immunefi |
| SOL-060 | ðŸ”´ critical | Index Price vs Mark Price Arbitrage | Sherlock |

---

## SOL-003: TWAP Calculation Always Equals Spot Price

**Severity:** ðŸ”´ CRITICAL  
**Platform:** Internal Audit  
**Protocol Type:** DeFi Protocol

### Description
TWAP calculation has algebraic error where historical cumulative price cancels out, making TWAP always equal current spot price.

### Impact
Flash loan price manipulation bypasses all TWAP protections.

### Vulnerable Code
```solidity
uint256 cumulativePrice = cumulativePriceLast + (tradePrice * elapsedTime);
uint256 twap = (cumulativePrice - cumulativePriceLast) / elapsedTime;
// Simplifies to: twap = tradePrice (bug!)
```

### Fix
```solidity
// Store previous cumulative price and timestamp
uint256 twap = (currentCumulative - storedCumulative) / 
               (block.timestamp - storedTimestamp);
```

---

## SOL-004: Stale Chainlink Price Not Checked

**Severity:** ðŸŸ  HIGH  
**Platform:** Code4rena  
**Protocol Type:** Lending Protocol

### Description
Protocol uses Chainlink price without checking updatedAt timestamp, allowing stale prices during network congestion.

### Impact
Incorrect liquidations or borrowing at wrong prices.

### Vulnerable Code
```solidity
(, int256 price, , ,) = priceFeed.latestRoundData();
return uint256(price);
```

### Fix
```solidity
(, int256 price, , uint256 updatedAt,) = priceFeed.latestRoundData();
require(block.timestamp - updatedAt < STALENESS_THRESHOLD, "Stale price");
return uint256(price);
```

---

## SOL-005: Missing minAnswer/maxAnswer Check

**Severity:** ðŸŸ  HIGH  
**Platform:** Sherlock  
**Protocol Type:** Lending Protocol

### Description
Chainlink price feeds have circuit breakers (minAnswer/maxAnswer). During flash crashes, price can be pinned at minAnswer.

### Impact
During market crash, assets valued at floor price enables unfair liquidations.

### Vulnerable Code
```solidity
(, int256 price, , ,) = priceFeed.latestRoundData();
```

### Fix
```solidity
(, int256 price, , ,) = priceFeed.latestRoundData();
require(price > minAnswer && price < maxAnswer, "Price out of bounds");
```

---

## SOL-024: L2 Sequencer Downtime Not Checked

**Severity:** ðŸŸ  HIGH  
**Platform:** Sherlock  
**Protocol Type:** Lending Protocol

### Description
On Arbitrum/Optimism, Chainlink prices may appear fresh but are stale if sequencer is down.

### Impact
Users liquidated at stale prices during sequencer outage.

### Vulnerable Code
```solidity
// Missing sequencer check on L2
(, int256 price, , uint256 updatedAt,) = feed.latestRoundData();
```

### Fix
```solidity
(, int256 answer, uint256 startedAt,,) = sequencerFeed.latestRoundData();
require(answer == 0, "Sequencer down");
require(block.timestamp - startedAt > GRACE_PERIOD, "Grace period");
```

---

## SOL-025: Hardcoded Oracle Decimals

**Severity:** ðŸŸ¡ MEDIUM  
**Platform:** Code4rena  
**Protocol Type:** DeFi Protocol

### Description
Protocol assumes all Chainlink feeds return 8 decimals, but some return 18.

### Impact
Prices off by factor of 10^10 for non-8-decimal feeds.

### Vulnerable Code
```solidity
uint256 price = uint256(answer) * 1e10;  // Assumes 8 decimals
```

### Fix
```solidity
uint8 decimals = feed.decimals();
uint256 price = uint256(answer) * 10**(18 - decimals);
```

---

## SOL-026: Uniswap V3 TWAP Manipulation via Low Liquidity

**Severity:** ðŸŸ  HIGH  
**Platform:** Sherlock  
**Protocol Type:** Lending Protocol

### Description
TWAP from low-liquidity Uniswap V3 pool can be manipulated cost-effectively.

### Impact
Attacker manipulates collateral price for profitable borrowing.

### Vulnerable Code
```solidity
// Using TWAP from pool with only $10k liquidity
(int24 tick,) = pool.observe([TWAP_PERIOD, 0]);
```

### Fix
```solidity
// Validate minimum liquidity
require(pool.liquidity() >= MIN_LIQUIDITY, "Insufficient liquidity");
// Or use Chainlink as primary oracle
```

---

## SOL-049: Curve LP Token Price Manipulation

**Severity:** ðŸ”´ CRITICAL  
**Platform:** Sherlock  
**Protocol Type:** Lending Protocol

### Description
Using get_virtual_price() for Curve LP valuation, manipulable via read-only reentrancy.

### Impact
Attacker inflates collateral value during Curve callback.

### Vulnerable Code
```solidity
function getLPValue(address pool) external view returns (uint256) {
    return ICurve(pool).get_virtual_price() * lpBalance;
}
```

### Fix
```solidity
// Check Curve reentrancy lock
// Or use Chainlink LP oracle
```

---

## SOL-051: Liquidation at Stale Price During Flash Crash

**Severity:** ðŸ”´ CRITICAL  
**Platform:** Immunefi  
**Protocol Type:** Lending Protocol

### Description
Oracle circuit breaker pins price at minAnswer during crash, but protocol liquidates at real price.

### Impact
Healthy positions liquidated at artificially low prices.

### Vulnerable Code
```solidity
// Oracle returns minAnswer during crash
// But AMM price keeps falling
```

### Fix
```solidity
require(price > minAnswer && price < maxAnswer, "Price breaker");
```

---

## SOL-060: Index Price vs Mark Price Arbitrage

**Severity:** ðŸ”´ CRITICAL  
**Platform:** Sherlock  
**Protocol Type:** Perp DEX

### Description
Large gap between index and mark price exploitable.

### Impact
Attacker profits from index/mark divergence.

### Vulnerable Code
```solidity
// No cap on mark-index deviation
// Large positions can push mark far from index
```

### Fix
```solidity
require(abs(markPrice - indexPrice) / indexPrice < MAX_DEVIATION);
```

---


*Imported from Solodit curated findings*
